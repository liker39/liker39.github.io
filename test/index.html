<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset=utf-8>
  <title>video要素、audio要素をJavaScriptから操作する　サンプル</title>
  <style>
    * { padding: 0; margin: 0; }
    canvas { background: #eee; display: block; margin: 0 auto; }
  </style>
</head>

<body>
  <video id="intputVideo" controls="true" width="400" height="400">
    <source src="Icon_B535_monsyo_A_800_800_green.mp4">
  </video>
  
  <canvas id="output" width="400" height="400"></canvas>
  
  <!-- <video id="video" width="400" height="300" controls>
    <source src="Icon_B535_monsyo_A_800_800_green.mp4">
  </video>
  <div style="width:400px; background-color:#333333; color:#ffffff;">
    <input type="button" value="再生" onClick="playVideo()">
    <input type="button" value="一時停止" onClick="pauseVideo()">
    現在（秒）：<span id="ichi">0</span><br>
    全体（秒）：<span id="nagasa"></span><br>
    <span id="kanryou"></span>

    <button id="prev-frame">戻る</button>
    <button id="next-frame">進む</button>

  </div> -->

  <script type="text/javascript">
    // HTML要素取得
    let output = document.getElementById('output');

    // 動画加工用イベント追加
    inputVideo.addEventListener("loadedmetadata", processVideo, false);


    // 関数2　「ファイル読み込み」 選択された動画が読み込まれたら実行、動画加工
    async function processVideo() {
        videoProcessor.videoInitialize();
    }



    // オブジェクト　「動画加工」　動画再生と並行して動画加工してcanvasに描く
    const videoProcessor = {
        // 関数3　「初期化」 動画処理の準備
        videoInitialize: function() {
            this.video = document.getElementById("inputVideo");
            this.c1 = document.getElementById("output");
            this.ctx1 = this.c1.getContext("2d");
            let self = this;
            //videoが再生されたら加工を始めるためのイベントを追加
            this.video.addEventListener("play", function() {
              self.width = self.video.width;
              self.height = self.video.height;
              requestAnimationFrame(self.timerCallback.bind(self));
            }, false);
          },

        // 関数4　「フレーム更新」 枚フレーム処理を行う
        timerCallback: function() {
            if (this.video.paused || this.video.ended) {return;}
            this.computeFrame();
            let self = this;
            requestAnimationFrame(self.timerCallback.bind(self));
            return;
        },
      
        // 関数5　「画像処理」 フレームを取得して画像処理を行う
        computeFrame: function() {
          this.ctx1.drawImage(this.video, 0, 0, this.width, this.height);
          let frame = this.ctx1.getImageData(0, 0, this.width, this.height);
      
          for (let i = 0; i < (frame.data.length / 4); i++) { // frameにはRGBAが1次元で並んでいるので4ずつ回す
            let grey = (frame.data[i * 4 + 0] + frame.data[i * 4 + 1] + frame.data[i * 4 + 2]) / 3; //RGB平均
            frame.data[i * 4 + 0] = grey;
            frame.data[i * 4 + 1] = grey;
            frame.data[i * 4 + 2] = grey;
          }
          this.ctx1.putImageData(frame, 0, 0);
          return;
        }
      
    }
    // var v = document.getElementById("video");
    // var prevFrame = document.getElementById('prev-frame');
    // var nextFrame = document.getElementById('next-frame');
    // var frameRate = 1/30;

    // function getDuration() {
    //   //動画の長さ（秒）を表示
    //   document.getElementById("nagasa").innerHTML = v.duration;
    // }

    // function playVideo() {
    //   //動画を再生
    //   v.play();

    //   //現在の再生位置（秒）を表示
    //   v.addEventListener("timeupdate", function(){
    //     document.getElementById("ichi").innerHTML = v.currentTime;
    //   }, false);

    //   //連続再生を行う
    //   v.addEventListener("ended", function(){
    //     v.play();
    //   }, false);
    // }

    // function pauseVideo() {
    //   //動画を一時停止
    //   v.pause();
    // }

    // video.onloadedmetadata = function(){
    //   //next
    //   nextFrame.addEventListener('click',function(){
    //       console.log('pushed next');
    //       video.currentTime = Math.min(video.duration, video.currentTime+frameRate);
    //   });

    //   //prev
    //   prevFrame.addEventListener('click',function(){
    //       console.log('pushed prev');
    //       video.currentTime = Math.max(0, video.currentTime-frameRate);
    //   });
    // } 

  </script>

</body> 
</html>