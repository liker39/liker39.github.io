<!DOCTYPE html>
<html lang="ja">

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils_3d/control_utils_3d.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" type="text/css" href="style.css">
  <title>KOKUYO</title>
  <meta charset="utf-8" />
</head>

<body>
  <h1>KOKUYOデモ</h1>
  <div class="container">
    <video class="input_video"></video>
    <canvas class="output_canvas" width="960px" height="540px"></canvas>
    <!-- <div class="landmark-grid-container"></div> -->
    <h2><span id="direction" class="badge badge-primary">向き</span></h2>
    <h2><span id="sample" class="badge badge-primary">動作</span></h2>
  </div>

  <script type="module">
    const isFlipped = true;
    
    let keypointsPose = [];

    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');
    videoElement.style.display = "none";

    function onResults(results) {
        keypointsPose = results.poseLandmarks;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.segmentationMask, 0, 0, canvasElement.width, canvasElement.height);
        
        canvasCtx.drawImage(
            results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        canvasCtx.globalCompositeOperation = 'source-over';
        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                        {color: '#00FF00', lineWidth: 4});
        drawLandmarks(canvasCtx, results.poseLandmarks,
                        {color: '#FF0000', lineWidth: 2});
        canvasCtx.restore();

        judge();
    
    }
    

    const pose = new Pose({
        locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        },
    });

    pose.setOptions({
      selfieMode: isFlipped,
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: true,
      smoothSegmentation: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5,
    });
    pose.onResults(onResults);
    
    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await pose.send({image: videoElement});
      },
      width: 960,
      height: 540
    });
    camera.start();

    // 距離計算
    function dist(x1,y1,x2,y2){
        return Math.sqrt( Math.pow( x2-x1, 2 ) + Math.pow( y2-y1, 2 ) ) ;
    }

    let direction = document.getElementById("direction");
    let obj = document.getElementById("sample");
    // 動作判定　向き判定
    function judge() {
        if(keypointsPose.length > 0){
            console.log('s');
            let motion;
            const key = {
                nose:            keypointsPose[0],
                left_eye_inner:  keypointsPose[1],
                left_eye:        keypointsPose[2],
                left_eye_outer:  keypointsPose[3],
                right_eye_inner: keypointsPose[4],
                right_eye:       keypointsPose[5],
                right_eye_outer: keypointsPose[6],
                left_ear:        keypointsPose[7],
                right_ear:       keypointsPose[8],
            }
            // console.log(key.nose);

            const distance = {
                nose_left_inner:  dist(key.nose.x, key.nose.y, key.left_eye_inner.x, key.left_eye_inner.y),
                nose_right_inner: dist(key.nose.x, key.nose.y, key.right_eye_inner.x, key.right_eye_inner.y),
                left_eye_size:    dist(key.left_eye_inner.x, key.left_eye_inner.y, key.left_eye_outer.x, key.left_eye_outer.y),
                right_eye_size:   dist(key.right_eye_inner.x, key.right_eye_inner.y, key.right_eye_outer.x, key.right_eye_outer.y),
                left_ear_outer:   dist(key.left_ear.x, key.left_ear.y, key.left_eye_outer.x, key.left_eye_outer.y),
                right_ear_outer:  dist(key.right_ear.x, key.right_ear.y, key.right_eye_outer.x, key.right_eye_outer.y),
            }
            let rate = (distance.nose_left_inner + distance.nose_right_inner)/2;

            

            if(distance.left_eye_size < distance.right_eye_size/1.5){
                // 右向いてる
                if(key.left_ear.y - key.left_eye_outer.y > rate/4) {
                    motion = "talking";
                }
                else{
                    motion = "working";
                }
                console.log('right');
                console.log(motion);
                obj.textContent = motion;
                direction.textContent = "右向き";
            }
            else if(distance.right_eye_size < distance.left_eye_size/1.5){
                // 左向いてる
                if(key.right_ear.y - key.right_eye_outer.y > rate/4) {
                    motion = "talking";
                }
                else{
                    motion = "working";
                }
                console.log('left');
                console.log(motion);
                obj.textContent = motion;
                direction.textContent = "左向き";
            }
            else{
                // 正面
                
                // 
                if(key.left_ear.y - key.left_eye_outer.y > rate/3 &&
                    key.right_ear.y - key.right_eye_outer.y > rate/3) {
                    motion = "talking";
                }
                else{
                    motion = "working";
                }
                console.log('center');
                console.log(motion);
                obj.textContent = motion;
                direction.textContent = "正面";
            }
        }
    }

    
    
    </script>
</body>

</html>
