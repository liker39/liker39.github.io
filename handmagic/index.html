<!DOCTYPE html>
<html lang="ja">

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" type="text/css" href="style.css">

  <meta charset="utf-8" />
</head>

<body>
  <video class="input_video"></video>
  <button onClick="change_effect()">change</button>
  <!-- <button onClick="select=1;change_effect()">red</button> -->

  <script>
    // ●Hands - mediapipe https://google.github.io/mediapipe/solutions/hands.html
    const isFlipped = true;

    let keypointsHand = [];

    const videoElement = document.getElementsByClassName("input_video")[0];
    videoElement.style.display = "none";

    function onHandsResults(results) {
      keypointsHand = results.multiHandLandmarks;
    }

    const hands = new Hands({
      locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
      },
    });

    hands.setOptions({
      selfieMode: isFlipped,
      maxNumHands: 1, // 最大1つに制限
      modelComplexity: 1,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5,
    });
    hands.onResults(onHandsResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({ image: videoElement });
      },
      width: 960,
      height: 540,
    });
    camera.start();

    

    // ビデオ読み込み
    function preload() {
      effect = [createVideo(['movie_resize/Icon_B508_hitodama_A.mp4']),
                createVideo(['movie_resize/Icon_B508_hitodama_B.mp4']),
                createVideo(['movie_resize/Icon_B535_monsyo_A.mp4']),
                createVideo(['movie_resize/Icon_B535_monsyo_C.mp4']),
                createVideo(['movie_resize/Wipe_B080_biribiri_blue.mp4']),
                createVideo(['movie_resize/Wipe_B080_biribiri_red.mp4']),
                createVideo(['movie_resize/Wipe_B080_biribiri_yellow.mp4']),
                createVideo(['movie_resize/Wipe_B081_sasaru_EFX_blue.mp4']),
                createVideo(['movie_resize/Wipe_B081_sasaru_EFX_red.mp4']),
                createVideo(['movie_resize/Wipe_B081_sasaru_EFX_yellow.mp4']),
                createVideo(['movie_resize/Wipe_B083_cyoi_EFX_T.mp4']),
                createVideo(['movie_resize/Wipe_B086_cyoi_EFX_X.mp4']),
                createVideo(['movie_resize/Wipe_B086_cyoi_EFX_Y.mp4'])
               ];
    }

    let select = 0;
    let videoImage;

    function setup() {
      createCanvas(1280, 760);
      videoImage = createGraphics(1280, 760);
      for(let i = 0; i<effect.length; i++){
        effect[i].hide();
      }
      effect[select].loop();
      noStroke();
      fill(0);
      magic = effect[select]
    }

    function change_effect(){
      effect[select].noLoop();
      select = (select + 1)%effect.length;
      effect[select].loop();
      magic = effect[select]
    }

    function blur_picture(){
      // エフェクトの加工
      magic.loadPixels();
      // console.log(magic.pixels);
      const imageData = magic.pixels
      for(var i = 0; i < (imageData.length)/4; i++) {
        if((imageData[i*4] < 100) && (imageData[i*4+1] > 150) && (imageData[i*4+2] < 100)) {
          magic.pixels[i*4] = 0;
          magic.pixels[i*4+1] = 0;
          magic.pixels[i*4+2] = 0;
          magic.pixels[i*4+3] = 0;
        }
      }
      
      for(var i = 0; i < (imageData.length)/4; i++) {
        if (magic.pixels[i*4+3] != 0){
          let sum = [0,0,0,0];
          for(var j = -1; j <= 1; j++){
            for(var k = -1; k <= 1; k++){
              sum[0] += magic.pixels[(i+j*magic.width+k)*4]/12;
              sum[1] += magic.pixels[(i+j*magic.width+k)*4+1]/12;
              sum[2] += magic.pixels[(i+j*magic.width+k)*4+2]/12;
              sum[3] += magic.pixels[(i+j*magic.width+k)*4+3]/12;
            }
          }
          magic.pixels[i*4] += sum[0];
          magic.pixels[i*4+1] += sum[1];
          magic.pixels[i*4+2] += sum[2];
          magic.pixels[i*4+3] += sum[3];
        }
      }
      magic.updatePixels();
    }

    function draw() {
      clear();
      background("rgba(100, 100, 255, 0.5)");

      videoImage.drawingContext.drawImage(
        videoElement,
        0,
        0,
        videoImage.width,
        videoImage.height
      );
      // tint(100,100,100,255);

      push();
      if (isFlipped) {
        translate(width, 0);
        scale(-1, 1);
      }
      // image(videoImage, 0, 0);
      displayWidth = width;
      displayHeight = (width * videoImage.height) / videoImage.width;
      image(videoImage, 0, 0, displayWidth, displayHeight);
      pop();


      //
      //
      // ここから条件分岐
      //
      //

      if (keypointsHand.length > 0) {
        if (select != 2 && select != 3){
          finger();
        } else {
          const pos = keypointsHand[0][9];

          const size = {
            bottom_pinky: keypointsHand[0][0],
            thumb_bottom: keypointsHand[0][2],
            index_bottom: keypointsHand[0][5],
            pinky_bottom: keypointsHand[0][17],
          };

          const display_distance = dist(0, 0, displayWidth, displayHeight);
          const distance = {
            vertical: dist(size.bottom_pinky.x, size.bottom_pinky.y, size.index_bottom.x, size.index_bottom.y),
            horizontal: dist(size.thumb_bottom.x, size.thumb_bottom.y, size.pinky_bottom.x, size.pinky_bottom.y),
          };

          const rate = 4000*Math.max(distance.vertical,distance.horizontal)/display_distance;

          blur_picture();
          // console.log(imagePNG);
          push();
          imageMode(CENTER); // 中心座標を基準に設定
          // tint(255, 128); // gray+A
          // image(
          //   imagePNG,
          //   pos.x * displayWidth, // x座標
          //   pos.y * displayHeight, // y座標
          //   imagePNG.width * rate, // 横サイズ
          //   imagePNG.height * rate // 縦サイズ
          // );
          image(
            magic,
            pos.x * displayWidth,
            pos.y * displayHeight,
            magic.width*rate,
            magic.height*rate);
          pop();
        }
      }

      function finger() {
        const pos = keypointsHand[0][8];

        const key = {
          bottom_pinky: keypointsHand[0][0],
          middle_top: keypointsHand[0][12],
          ring_top: keypointsHand[0][16],
          pinky_top: keypointsHand[0][20],
          index_top: keypointsHand[0][8],
          index_bottom: keypointsHand[0][5]
        };

        const display_distance = dist(0, 0, displayWidth, displayHeight);
        const distance = {
          top_3: dist(pos.x, pos.y, key.middle_top.x, key.middle_top.y),
          top_4: dist(pos.x, pos.y, key.ring_top.x, key.ring_top.y),
          top_5: dist(pos.x, pos.y, key.pinky_top.x, key.pinky_top.y),
          bottom_3: dist(key.bottom_pinky.x, key.bottom_pinky.y, key.middle_top.x, key.middle_top.y),
          bottom_4: dist(key.bottom_pinky.x, key.bottom_pinky.y, key.ring_top.x, key.ring_top.y),
          bottom_5: dist(key.bottom_pinky.x, key.bottom_pinky.y, key.pinky_top.x, key.pinky_top.y),
          size: dist(key.index_top.x, key.index_top.y, key.index_bottom.x, key.index_bottom.y),
        };
        
        const far = 1
        if (distance.top_3 > distance.bottom_3*far 
        && distance.top_4 > distance.bottom_4*far
        && distance.top_5 > distance.bottom_5*far){
          const rate = 100*distance.size;
          blur_picture();
          // console.log(imagePNG);
          push();
          imageMode(CENTER); // 中心座標を基準に設定
          // tint(255, 128); // gray+A
          // image(
          //   imagePNG,
          //   pos.x * displayWidth, // x座標
          //   pos.y * displayHeight, // y座標
          //   imagePNG.width * rate, // 横サイズ
          //   imagePNG.height * rate // 縦サイズ
          // );
          image(
            magic,
            pos.x * displayWidth,
            pos.y * displayHeight,
            magic.width*rate,
            magic.height*rate);
          pop();
        }
        // const rate = 4000*Math.max(distance.vertical,distance.horizontal)/display_distance;

        
      }


      // push();
      // fill(0, 0, 0);
      // rect(5, 5, 270, 80);
      // textSize(14);
      // fill(255, 255, 255);
      // text("手をグーの状態でカメラにうつして", 20, 30);
      // text("指を1本ずつ指を立ててください。", 20, 50);
      // text("rキーで表示がリセットされます。", 20, 70);
      // pop();
    }

    

    // リセット用　グーの状態でrが押されたとき
    // document.addEventListener('keydown', (event) => {
    //   if (event.key === "r") {
        
    //   }
    // });

  </script>
</body>

</html>
