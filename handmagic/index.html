<!DOCTYPE html>
<html lang="ja">

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" type="text/css" href="style.css">

  <meta charset="utf-8" />
</head>

<body>
  <video class="input_video"></video>
  <button onClick="change_effect()">change</button>
  <!-- <button onClick="select=1;change_effect()">red</button> -->

  <script>
    // ●Hands - mediapipe https://google.github.io/mediapipe/solutions/hands.html
    const isFlipped = true;

    let keypointsHand = [];

    const videoElement = document.getElementsByClassName("input_video")[0];
    videoElement.style.display = "none";

    function onHandsResults(results) {
      keypointsHand = results.multiHandLandmarks;
    }

    const hands = new Hands({
      locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
      },
    });

    hands.setOptions({
      selfieMode: isFlipped,
      maxNumHands: 1, // 最大1つに制限
      modelComplexity: 1,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5,
    });
    hands.onResults(onHandsResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({ image: videoElement });
      },
      width: 960,
      height: 540,
    });
    camera.start();

    

    // ビデオ読み込み
    function preload() {
      effect = [createVideo(['movie_resize/Icon_B508_hitodama_A.mp4']),
                createVideo(['movie_resize/Icon_B508_hitodama_B.mp4']),
                createVideo(['movie_resize/Icon_B535_monsyo_A.mp4']),
                createVideo(['movie_resize/Icon_B535_monsyo_C.mp4']),
                createVideo(['movie_resize/Wipe_B080_biribiri_blue.mp4']),
                createVideo(['movie_resize/Wipe_B080_biribiri_red.mp4']),
                createVideo(['movie_resize/Wipe_B080_biribiri_yellow.mp4']),
                createVideo(['movie_resize/Wipe_B081_sasaru_EFX_blue.mp4']),
                createVideo(['movie_resize/Wipe_B081_sasaru_EFX_red.mp4']),
                createVideo(['movie_resize/Wipe_B081_sasaru_EFX_yellow.mp4']),
                createVideo(['movie_resize/Wipe_B083_cyoi_EFX_T.mp4']),
                createVideo(['movie_resize/Wipe_B086_cyoi_EFX_X.mp4']),
                createVideo(['movie_resize/Wipe_B086_cyoi_EFX_Y.mp4'])
               ];
    }

    let select = 0;
    let videoImage;
    

    function setup() {
      createCanvas(960, 540);
      videoImage = createGraphics(960, 540);
      for(let i = 0; i<effect.length; i++){
        effect[i].hide();
      }
      effect[select].loop();
      noStroke();
      fill(0);
      magic = effect[select]
    }

    function change_effect(){
      effect[select].noLoop();
      select = (select + 1)%effect.length;
      effect[select].loop();
      magic = effect[select]
    }

    function blur_picture(){
      // エフェクトの加工
      magic.loadPixels();
      // console.log(magic.pixels);
      const imageData = magic.pixels
      for(var i = 0; i < (imageData.length)/4; i++) {
        if((imageData[i*4] < 100) && (imageData[i*4+1] > 150) && (imageData[i*4+2] < 100)) {
          magic.pixels[i*4] = 0;
          magic.pixels[i*4+1] = 0;
          magic.pixels[i*4+2] = 0;
          magic.pixels[i*4+3] = 0;
        } else {
          magic.pixels[i*4+3] = 128;
        }
      }
      
      for(var i = 0; i < (imageData.length)/4; i++) {
        if (magic.pixels[i*4+3] != 0){
          let sum = [0,0,0,0];
          for(var j = -1; j <= 1; j++){
            for(var k = -1; k <= 1; k++){
              sum[0] += magic.pixels[(i+j*magic.width+k)*4]/12;
              sum[1] += magic.pixels[(i+j*magic.width+k)*4+1]/12;
              sum[2] += magic.pixels[(i+j*magic.width+k)*4+2]/12;
              sum[3] += magic.pixels[(i+j*magic.width+k)*4+3]/9;
            }
          }
          magic.pixels[i*4] += sum[0];
          magic.pixels[i*4+1] += sum[1];
          magic.pixels[i*4+2] += sum[2];
          magic.pixels[i*4+3] += sum[3];
        }
      }
      magic.updatePixels();
    }

    function draw() {
      clear();
      // background("rgba(100, 100, 255, 0.5)");
      const displayWidth = width;
      const displayHeight = (width * videoImage.height) / videoImage.width;
      const display_distance = dist(0, 0, displayWidth, displayHeight);

      videoImage.drawingContext.drawImage(
        videoElement,
        0,
        0,
        videoImage.width,
        videoImage.height
      );
      // tint(100,100,100,255);
      
      push();
      if (isFlipped) {
        translate(width, 0);
        scale(-1, 1);
      }
      // image(videoImage, 0, 0);
      // fill(0,0,0,100)
      image(videoImage, 0, 0, displayWidth, displayHeight);
      pop();


      //
      //
      // ここから条件分岐
      //
      //

      if (keypointsHand.length > 0) {
        if (select != 2 && select != 3){
          finger();
        } else {
          const pos = keypointsHand[0][9];

          const size = {
            bottom_pinky: keypointsHand[0][0],
            thumb_bottom: keypointsHand[0][2],
            index_bottom: keypointsHand[0][5],
            pinky_bottom: keypointsHand[0][17],
            thumb_top: keypointsHand[0][4],
            index_top: keypointsHand[0][8],
            middle_top: keypointsHand[0][12],
            ring_top: keypointsHand[0][16],
            pinky_top: keypointsHand[0][20],
          };

          const distance = {
            standard: dist(size.index_bottom.x, size.index_bottom.y, size.bottom_pinky.x, size.bottom_pinky.y),
            dis_thumb: dist(size.thumb_top.x, size.thumb_top.y, size.bottom_pinky.x, size.bottom_pinky.y),
            dis_index: dist(size.index_top.x, size.index_top.y, size.bottom_pinky.x, size.bottom_pinky.y),
            dis_middle: dist(size.middle_top.x, size.middle_top.y, size.bottom_pinky.x, size.bottom_pinky.y),
            dis_ring: dist(size.ring_top.x, size.ring_top.y, size.bottom_pinky.x, size.bottom_pinky.y),
            dis_pinky: dist(size.pinky_top.x, size.pinky_top.y, size.bottom_pinky.x, size.bottom_pinky.y),
          };

          const thres = 0.7;
          const dis_all = (distance.dis_thumb + distance.dis_index + distance.dis_middle + distance.dis_ring + distance.dis_pinky)/5;
          const rate = 3000*dis_all/display_distance;

          if (dis_all > distance.standard*thres){
            blur_picture();
            push();
            imageMode(CENTER); // 中心座標を基準に設定
            image(
              magic,
              pos.x * displayWidth,
              pos.y * displayHeight,
              magic.width*rate,
              magic.height*rate);
            pop();
          }
        }
      }

      function finger() {
        const displayWidth = width;
        const displayHeight = (width * videoImage.height) / videoImage.width;
        const display_distance = dist(0, 0, displayWidth, displayHeight);
        const pos = keypointsHand[0][8];

        const key = {
          bottom_pinky: keypointsHand[0][0],
          middle_top: keypointsHand[0][12],
          ring_top: keypointsHand[0][16],
          pinky_top: keypointsHand[0][20],
          index_top: keypointsHand[0][8],
          index_bottom: keypointsHand[0][5]
        };

        
        const distance = {
          top_3: dist(pos.x, pos.y, key.middle_top.x, key.middle_top.y),
          top_4: dist(pos.x, pos.y, key.ring_top.x, key.ring_top.y),
          top_5: dist(pos.x, pos.y, key.pinky_top.x, key.pinky_top.y),
          bottom_3: dist(key.bottom_pinky.x, key.bottom_pinky.y, key.middle_top.x, key.middle_top.y),
          bottom_4: dist(key.bottom_pinky.x, key.bottom_pinky.y, key.ring_top.x, key.ring_top.y),
          bottom_5: dist(key.bottom_pinky.x, key.bottom_pinky.y, key.pinky_top.x, key.pinky_top.y),
          size: dist(key.index_top.x, key.index_top.y, key.index_bottom.x, key.index_bottom.y),
        };
        
        const far = 1.5
        if (distance.top_3 > distance.bottom_3*far 
        && distance.top_4 > distance.bottom_4*far
        && distance.top_5 > distance.bottom_5*far){
          const rate = 2500*distance.size/display_distance;
          blur_picture();
          // console.log(imagePNG);
          if (select == 7 || select == 8 || select == 9) {
            arrow();
          }else{
            push();
            imageMode(CENTER); // 中心座標を基準に設定
            image(
              magic,
              pos.x * displayWidth,
              pos.y * displayHeight,
              magic.width*rate,
              magic.height*rate);
            pop();
          }
        }

        
      }

      function arrow() {
        const displayWidth = width;
        const displayHeight = (width * videoImage.height) / videoImage.width;
        const display_distance = dist(0, 0, displayWidth, displayHeight);
        const pos = keypointsHand[0][8];

        const key = {
          index_top: keypointsHand[0][8],
          index_bottom: keypointsHand[0][5]
        };


        x = key.index_top.x - key.index_bottom.x;
        y = key.index_top.y - key.index_bottom.y;
        dis = dist(key.index_top.x, key.index_top.y, key.index_bottom.x, key.index_bottom.y)
        rad = Math.atan2(y, x)+Math.PI;
        console.log(rad * ( 180 / Math.PI ) );

        const rate = 3500*dis/display_distance;
        push();
        translate(pos.x*displayWidth, pos.y*displayHeight);  // 指先に移動
        rotate(rad+3*Math.PI/4);
        // imageMode(CENTER); // 中心座標を基準に設定
        image(
          magic,
          0,
          0,
          magic.width*rate,
          magic.height*rate);
        pop();
      }
      // push();
      // fill(0, 0, 0);
      // rect(5, 5, 270, 80);
      // textSize(14);
      // fill(255, 255, 255);
      // text("手をグーの状態でカメラにうつして", 20, 30);
      // text("指を1本ずつ指を立ててください。", 20, 50);
      // text("rキーで表示がリセットされます。", 20, 70);
      // pop();
    }

    

    // リセット用　グーの状態でrが押されたとき
    // document.addEventListener('keydown', (event) => {
    //   if (event.key === "r") {
        
    //   }
    // });

  </script>
</body>

</html>
